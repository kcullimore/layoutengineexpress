
wsStatus <- function(WS) {
    container_info <- WS$container$getInfo()
    if (!container_info$running) {
        ready <- FALSE
    } else {
        
        ready <- (WS$ws$readyState() == 1)
    }
    list(ready=ready)
}

wsOpen <- function(settings) {
    ## Docker container setup and status variables
    container <- dockerContainer(settings)
    container$run()
    container_info <- container$getInfo()

    ## Establish websocket connection
    ws <- websocket::WebSocket$new(paste0("ws://",
                                          settings$url, ":",
                                          settings$portServer),
                                   maxMessageSize=1e6)

    ## Define onMessage behaivor
    ws$onMessage(function(event) {
        msg <- invisible(jsonlite::fromJSON(event$data))
        ID <- getOption("layoutEngine.wsID")
        if (msg$event == "receipt" && msg$id != ID) {            
            options(layoutEngine.wsID=msg$id)    
        } else if (msg$event == "message") {
            options(layoutEngine.wsMessage=msg$message)            
        }
    })
    
    list(ws=ws, container=container, dir=container_info$dir)
}

wsClose <- function(WS) {
    container_info <- WS$container$getInfo()
    name <- WS$container$name
    if (!container_info$running) {
        message("Express server is not running.")
    } else {
        WS$container$close()
        message(paste0("Express server running in docker container '",
                       name, "' has been closed."))
    }
}

webSocket <- function(settings) {

    WS <- webSocketOpen(settings)
    getStatus <- function() {
        wsStatus(WS)
    }

    open <- function() {
        wsOpen(settings)
    }

    close <- function() {
        wsClose(WS)
    }

    ## rSServer object
    c(WS, getStatus=getStatus, open=open, close=close)
}
