

WSSessionOpen <- function(WS) {
    WSS_ready <- FALSE    
    WS_ready <- WS$getStatus()$ready
    if (!WS_ready) {
        WS$open()
    }
    browser_session <- getOption("layoutEngine.wsID")
    browser_count <- length(browser_session)
    if (browser_count == 0) {
        WS$open()
        ID <- getOption("layoutEngine.wsID")
        browser_session <- getOption("layoutEngine.wsID")
        WSS_ready <- TRUE        
        message("Express browser session has been created.")
    } else {
        WSS_ready <- TRUE
    }
    WSS <- list(ready=WSS_ready,
                 ws=WS$ws,
                 dir=WS$dir,
                 close=WS$container$close,
                 session=browser_session)
    options(layoutEngine.WSSession=WSS)
    WSS
}

WSSessionClose <- function(WS) {
    if (!WS$getStatus()$ready) {
        message("Express browser session is not active so cannot be closed.")
    } else {
        WS$container$close() 
    }
}

WSSession <- function(url="0.0.0.0", portRS=8080L, portClient="8080",
                       network="host", fresh_pull=FALSE) {

    settings <- list(url=url, portRS=portRS, portClient=portClient,
                     network=network, fresh_pull=fresh_pull)

    ## RSelenium server setup
    WS <- webSocket(settings)

    ## RSelenium browser session setup 
    WSSession <- WSSessionOpen(WS)
    
    open <- function() {
        WSSessionOpen(WS)
    }

    close <- function() {
        WSSessionClose(WSS)
    }
    c(WSS, open=open, close=close)
}
